<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç Realtime –ü—ñ–¥–ø–∏—Å–∫–∏</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .status-box {
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .status-box.success {
            border-left: 4px solid #10b981;
        }

        .status-box.error {
            border-left: 4px solid #ef4444;
        }

        .status-box.warning {
            border-left: 4px solid #f59e0b;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #3b82f6;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background: #2563eb;
        }

        .log {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 2px solid #10b981;
            padding-left: 10px;
        }

        .log-entry.error {
            border-left-color: #ef4444;
            color: #ef4444;
        }

        .log-entry.info {
            border-left-color: #3b82f6;
            color: #3b82f6;
        }
    </style>
</head>

<body>
    <h1>üîç –¢–µ—Å—Ç Realtime –ü—ñ–¥–ø–∏—Å–∫–∏ –¥–ª—è post_arxiv</h1>

    <div class="status-box" id="connectionStatus">
        <h3>üì° –°—Ç–∞—Ç—É—Å –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è</h3>
        <p id="statusText">–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è...</p>
    </div>

    <div class="status-box">
        <h3>üéÆ –î—ñ—ó</h3>
        <button onclick="testConnection()">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è</button>
        <button onclick="testInsert()">–¢–µ—Å—Ç–æ–≤–∏–π INSERT</button>
        <button onclick="testUpdate()">–¢–µ—Å—Ç–æ–≤–∏–π UPDATE</button>
        <button onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç–∏ –ª–æ–≥</button>
    </div>

    <div class="status-box">
        <h3>üìä –õ–æ–≥ –ø–æ–¥—ñ–π</h3>
        <div class="log" id="eventLog"></div>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

        // –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –∑ .env (–∑–∞–º—ñ–Ω—ñ—Ç—å –Ω–∞ –≤–∞—à—ñ)
        const SUPABASE_URL = 'https://hprzwzqfdnryysqutenc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhwcnp3enFmZG5yeXlzcXV0ZW5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MDU5NjEsImV4cCI6MjA4NjQ4MTk2MX0.1eFmKP-mJPafsIXnCyMSEZcue8YqTW5HAnjJ7JbMCw8';

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let channel = null;

        function addLog(message, type = 'info') {
            const log = document.getElementById('eventLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString('uk-UA');
            entry.textContent = `[${timestamp}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function updateStatus(message, type = 'warning') {
            const statusBox = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            statusBox.className = `status-box ${type}`;
            statusText.textContent = message;
        }

        async function initRealtime() {
            addLog('üöÄ –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Realtime –ø—ñ–¥–ø–∏—Å–∫–∏...', 'info');

            channel = supabase
                .channel('test-post-arxiv-changes')
                .on(
                    'postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'post_arxiv',
                    },
                    (payload) => {
                        const eventType = payload.eventType;
                        addLog(`üì® –û—Ç—Ä–∏–º–∞–Ω–æ –ø–æ–¥—ñ—é: ${eventType}`, 'info');
                        addLog(`üì¶ –î–∞–Ω—ñ: ${JSON.stringify(payload.new || payload.old)}`, 'info');

                        if (eventType === 'INSERT') {
                            addLog('‚úÖ INSERT —É—Å–ø—ñ—à–Ω–æ –æ—Ç—Ä–∏–º–∞–Ω–æ!', 'info');
                        } else if (eventType === 'UPDATE') {
                            addLog('‚úÖ UPDATE —É—Å–ø—ñ—à–Ω–æ –æ—Ç—Ä–∏–º–∞–Ω–æ!', 'info');
                        } else if (eventType === 'DELETE') {
                            addLog('‚úÖ DELETE —É—Å–ø—ñ—à–Ω–æ –æ—Ç—Ä–∏–º–∞–Ω–æ!', 'info');
                        }
                    }
                )
                .subscribe((status) => {
                    addLog(`üì° –°—Ç–∞—Ç—É—Å –∫–∞–Ω–∞–ª—É: ${status}`, 'info');

                    if (status === 'SUBSCRIBED') {
                        updateStatus('‚úÖ –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–æ Realtime!', 'success');
                        addLog('‚úÖ –ü—ñ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞! –û—á—ñ–∫—É—î–º–æ –ø–æ–¥—ñ—ó...', 'info');
                    } else if (status === 'CHANNEL_ERROR') {
                        updateStatus('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Realtime', 'error');
                        addLog('‚ùå –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —á–∏ —É–≤—ñ–º–∫–Ω–µ–Ω–∏–π Realtime –¥–ª—è —Ç–∞–±–ª–∏—Ü—ñ post_arxiv', 'error');
                    } else if (status === 'TIMED_OUT') {
                        updateStatus('‚è±Ô∏è –ß–∞—Å –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è –≤–∏—á–µ—Ä–ø–∞–Ω–æ', 'error');
                        addLog('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è –¥–æ Realtime', 'error');
                    } else if (status === 'CLOSED') {
                        updateStatus("üîå –ó'—î–¥–Ω–∞–Ω–Ω—è –∑–∞–∫—Ä–∏—Ç–æ", 'warning');
                        addLog("‚ö†Ô∏è –ö–∞–Ω–∞–ª –∑–∞–∫—Ä–∏—Ç–æ", 'warning');
                    }
                });
        }

        window.testConnection = async () => {
            addLog('üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Supabase...', 'info');

            try {
                const { data, error } = await supabase
                    .from('post_arxiv')
                    .select('post_arxiv_id')
                    .limit(1);

                if (error) {
                    addLog(`‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`, 'error');
                    updateStatus('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –ë–î', 'error');
                } else {
                    addLog('‚úÖ –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –ë–î –ø—Ä–∞—Ü—é—î!', 'info');
                    updateStatus('‚úÖ –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –ë–î –ø—Ä–∞—Ü—é—î', 'success');
                }
            } catch (err) {
                addLog(`‚ùå –í–∏–Ω—è—Ç–æ–∫: ${err.message}`, 'error');
                updateStatus('‚ùå –ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞', 'error');
            }
        };

        window.testInsert = async () => {
            addLog('üìù –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É...', 'info');

            try {
                const testData = {
                    slyusar_id: 1,
                    name_post: 1,
                    client_id: '–¢–µ—Å—Ç|||380000000000',
                    cars_id: '–¢–µ—Å—Ç–æ–≤–∞ –º–∞—à–∏–Ω–∞|||AA0000AA',
                    status: '–ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–∏–π',
                    data_on: new Date().toISOString(),
                    data_off: new Date(Date.now() + 3600000).toISOString(),
                    komentar: '–¢–µ—Å—Ç–æ–≤–∏–π –∑–∞–ø–∏—Å –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ Realtime',
                    xto_zapusav: '–¢–µ—Å—Ç–æ–≤–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á'
                };

                const { data, error } = await supabase
                    .from('post_arxiv')
                    .insert(testData)
                    .select()
                    .single();

                if (error) {
                    addLog(`‚ùå –ü–æ–º–∏–ª–∫–∞ INSERT: ${error.message}`, 'error');
                } else {
                    addLog(`‚úÖ –ó–∞–ø–∏—Å —Å—Ç–≤–æ—Ä–µ–Ω–æ! ID: ${data.post_arxiv_id}`, 'info');
                    addLog('‚è≥ –û—á—ñ–∫—É—î–º–æ Realtime –ø–æ–¥—ñ—é...', 'info');
                }
            } catch (err) {
                addLog(`‚ùå –í–∏–Ω—è—Ç–æ–∫: ${err.message}`, 'error');
            }
        };

        window.testUpdate = async () => {
            addLog('üîÑ –û–Ω–æ–≤–ª–µ–Ω–Ω—è –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –∑–∞–ø–∏—Å—É...', 'info');

            try {
                // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –æ—Å—Ç–∞–Ω–Ω—ñ–π –∑–∞–ø–∏—Å
                const { data: lastRecord, error: selectError } = await supabase
                    .from('post_arxiv')
                    .select('post_arxiv_id')
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .single();

                if (selectError || !lastRecord) {
                    addLog('‚ùå –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å—ñ–≤ –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è', 'error');
                    return;
                }

                // –û–Ω–æ–≤–ª—é—î–º–æ –∑–∞–ø–∏—Å
                const { data, error } = await supabase
                    .from('post_arxiv')
                    .update({
                        komentar: `–û–Ω–æ–≤–ª–µ–Ω–æ –æ ${new Date().toLocaleTimeString('uk-UA')}`,
                        xto_zapusav: '–¢–µ—Å—Ç–æ–≤–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á (–æ–Ω–æ–≤–ª–µ–Ω–Ω—è)'
                    })
                    .eq('post_arxiv_id', lastRecord.post_arxiv_id)
                    .select()
                    .single();

                if (error) {
                    addLog(`‚ùå –ü–æ–º–∏–ª–∫–∞ UPDATE: ${error.message}`, 'error');
                } else {
                    addLog(`‚úÖ –ó–∞–ø–∏—Å –æ–Ω–æ–≤–ª–µ–Ω–æ! ID: ${data.post_arxiv_id}`, 'info');
                    addLog('‚è≥ –û—á—ñ–∫—É—î–º–æ Realtime –ø–æ–¥—ñ—é...', 'info');
                }
            } catch (err) {
                addLog(`‚ùå –í–∏–Ω—è—Ç–æ–∫: ${err.message}`, 'error');
            }
        };

        window.clearLog = () => {
            document.getElementById('eventLog').innerHTML = '';
            addLog('üßπ –õ–æ–≥ –æ—á–∏—â–µ–Ω–æ', 'info');
        };

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
        initRealtime();
    </script>
</body>

</html>