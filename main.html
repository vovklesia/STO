<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8" />
    <title>–û—Å–Ω–æ–≤–Ω–∏–π</title>

    <!-- üîí –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ Google —Å–µ—Å—ñ—ó -->
    <script type="module" src="./src/ts/roboha/main_session_guard.ts"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <link rel="icon" type="image/svg+xml" href="/logo.png" />

    <style>
        /* –°—Ç–∏–ª—ñ –¥–ª—è –ø–æ—à—É–∫—É */
        .search-container {
            display: flex;
            align-items: center;
            position: relative;
            margin-left: 15px;
        }

        .search-input {
            width: 0;
            padding: 0;
            border: none;
            border-bottom: 2px solid rgba(255, 255, 255, 0.5);
            background: transparent;
            color: #333;
            font-size: 16px;
            outline: none;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            visibility: hidden;
        }

        .search-input.active {
            width: 220px;
            padding: 5px 10px;
            opacity: 1;
            visibility: visible;
            margin-left: 5px;
            border-bottom: 2px solid #4a90e2;
        }

        .search-icon {
            cursor: pointer;
            font-size: 1.4em;
            padding: 5px;
            color: #555;
            transition: color 0.3s;
        }

        .search-icon:hover {
            color: #4a90e2;
            transform: scale(1.1);
        }

        .search-input::placeholder {
            color: rgba(0, 0, 0, 0.4);
            font-style: italic;
        }
    </style>
</head>

<body class="page-2">
    <ul class="main-menu">
        <div class="user-info" id="userInfoBlock" style="display: none;">
            <div class="user-surname"></div>
            <div class="user-access"></div>
        </div>

        <div class="menu-items" id="menu-items-to-hide" style="display: none;">
            <li><a href="#" id="logout-link" class="menu-link"
                    onclick="window.logoutFromSystemAndRedirect(); return false;">–í–∏—Ö—ñ–¥</a></li>
            <li><a href="#" class="menu-link" data-action="openSettings">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</a></li>
            <li><a href="#" class="menu-link all_other_bases" data-action="openClient">–î–æ–¥–∞—Ç–∏</a></li>
            <li><a href="bukhhalteriya.html" class="menu-link all_other_bases_Bukhh"
                    data-action="openBukhhalteriya">–ë—É—Ö–≥–∞–ª—Ç–µ—Ä—ñ—è</a></li>
            <li class="active"><a href="#" class="menu-link" data-action="openHome">–ù–∞—Ä—è–¥</a></li>
            <li style="display: none;" id="menu-item-planyvannya"><a href="planyvannya.html" class="menu-link"
                    data-action="openPlanyvannya">–ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è</a></li>

            <li><input type="text" id="dateRangePicker" readonly /></li>

            <li class="search-container">
                <span id="searchIcon" class="search-icon" title="–ü–æ—à—É–∫">üîç</span>
                <input type="text" id="searchInput" class="search-input" placeholder="–í–≤–µ–¥—ñ—Ç—å –¥–ª—è –ø–æ—à—É–∫—É" />
            </li>
        </div>
        <li class="alim">1.3.0 / ¬© 2025 A-Service</li>
    </ul>

    <a href="#" id="open-modal-sakaz_narad"></a>
    <a href="#" id="open-modal-create-sakaz_narad"></a>
    <a href="#" id="open-modal-all_other_bases"></a>
    <a href="#" id="open-modal-settings"></a>
    <a href="#" id="open-modal-Bukhh"></a>

    <div id="table-container-modal-sakaz_narad"></div>

    <script type="module" src="/src/ts/main.ts"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

    <script type="module">
        import { setupSearchWithTableFilter } from "/src/ts/roboha/tablucya/pochuk.ts";
        import { loadActsTable, initializeActsSystem } from "/src/ts/roboha/tablucya/tablucya.ts";
        import {
            showLoginModalBeforeTable,
            updateUIBasedOnAccess,
            logoutFromSystemAndRedirect
        } from "/src/ts/roboha/tablucya/users.ts";

        window.logoutFromSystemAndRedirect = logoutFromSystemAndRedirect;

        /**
         * –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó (—à–≤–∏–¥–∫–∞)
         */
        function checkAuthLocal() {
            const storedData = localStorage.getItem("userAuthData");
            if (!storedData) return false;
            try {
                const parsed = JSON.parse(storedData);
                return !!(parsed.Name && parsed.–î–æ—Å—Ç—É–ø);
            } catch { return false; }
        }

        /**
         * –§—É–Ω–∫—Ü—ñ—è –ë–õ–û–ö–£–í–ê–ù–ù–Ø (–≤–∏–∫–ª–∏–∫–∞—î–º–æ –ø—Ä–∏ –∫–ª—ñ–∫—É)
         */
        function blockActionIfNoAuth(e) {
            if (!checkAuthLocal()) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();

                // üõë –¢–£–¢ –í–ò–í–û–î–ò–ú–û –ü–û–í–Ü–î–û–ú–õ–ï–ù–ù–Ø –ü–†–û –ë–õ–û–ö–£–í–ê–ù–ù–Ø
                alert("‚õî –î–æ—Å—Ç—É–ø –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ. –í–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ.");

                return true; // –ó–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ
            }
            return false; // –î–æ–∑–≤–æ–ª–µ–Ω–æ
        }

        function updateMenuVisibility(isVisible) {
            const menu = document.getElementById("menu-items-to-hide");
            if (menu) {
                menu.style.display = isVisible ? "flex" : "none";
            }
        }

        function updateUserInfoDisplay() {
            try {
                const storedData = localStorage.getItem("userAuthData");
                if (storedData) {
                    const userData = JSON.parse(storedData);
                    const userInfoDiv = document.getElementById('userInfoBlock');
                    const userSurnameElement = document.querySelector('.user-surname');
                    const userAccessElement = document.querySelector('.user-access');

                    if (userSurnameElement) userSurnameElement.textContent = userData.Name;
                    if (userAccessElement) userAccessElement.textContent = userData.–î–æ—Å—Ç—É–ø;
                    if (userInfoDiv) userInfoDiv.style.display = 'flex';
                }
            } catch (error) { console.error(error); }
        }

        // --- –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –ë–õ–û–ö–£–í–ê–ù–ù–Ø –î–õ–Ø –ü–û–®–£–ö–£ –¢–ê –ö–ê–õ–ï–ù–î–ê–†–Ø ---
        function setupBlockers() {
            // 1. –ë–ª–æ–∫—É—î–º–æ –ü–û–®–£–ö


            $('#searchInput').on('focus click keydown', function (e) {
                if (blockActionIfNoAuth(e)) {
                    $(this).blur(); // –ü—Ä–∏–±–∏—Ä–∞—î–º–æ —Ñ–æ–∫—É—Å
                }
            });

            // 2. –ë–ª–æ–∫—É—î–º–æ –ö–ê–õ–ï–ù–î–ê–†
            // –ü–µ—Ä–µ—Ö–æ–ø–ª—é—î–º–æ –ø–æ–¥—ñ—é –ø–µ—Ä–µ–¥ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è–º
            $('#dateRangePicker').on('show.daterangepicker', function (e, picker) {
                if (!checkAuthLocal()) {
                    picker.hide(); // –ù–µ–≥–∞–π–Ω–æ —Ö–æ–≤–∞—î–º–æ
                    e.preventDefault();
                    alert("‚õî –î–æ—Å—Ç—É–ø –¥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ. –í–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ.");
                }
            });

            // –ë–ª–æ–∫—É—î–º–æ –∫–ª—ñ–∫ –ø–æ —ñ–Ω–ø—É—Ç—É –∫–∞–ª–µ–Ω–¥–∞—Ä—è
            $('#dateRangePicker').on('click focus', function (e) {
                if (blockActionIfNoAuth(e)) {
                    $(this).blur();
                }
            });
        }

        function initializeSystem() {
            let currentFilterType = 'open';

            // –ó–∞–ø—É—Å–∫–∞—î–º–æ –ª–æ–≥—ñ–∫—É –±–ª–æ–∫—É–≤–∞–ª—å–Ω–∏–∫—ñ–≤
            setupBlockers();

            // –ó–∞–∫—Ä–∏—Ç—Ç—è –ø–æ—à—É–∫—É –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –Ω–∏–º
            $(document).on('click', function (e) {
                if (!$(e.target).closest('.search-container').length) {
                    const input = $('#searchInput');
                    if (input.hasClass('active') && input.val() === '') {
                        input.removeClass('active');
                    }
                }
            });

            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è DateRangePicker
            $('#dateRangePicker').daterangepicker(
                {
                    locale: {
                        format: 'DD.MM.YYYY',
                        separator: ' - ',
                        applyLabel: '–ü—Ä–∏–π–Ω—è—Ç–∏',
                        cancelLabel: '–í—ñ–¥–º—ñ–Ω–∏—Ç–∏',
                        fromLabel: '–í—ñ–¥',
                        toLabel: '–î–æ',
                        weekLabel: '–¢–∏–∂',
                        daysOfWeek: ['–ù–¥', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'],
                        monthNames: ['–°—ñ—á–µ–Ω—å', '–õ—é—Ç–∏–π', '–ë–µ—Ä–µ–∑–µ–Ω—å', '–ö–≤—ñ—Ç–µ–Ω—å', '–¢—Ä–∞–≤–µ–Ω—å', '–ß–µ—Ä–≤–µ–Ω—å', '–õ–∏–ø–µ–Ω—å', '–°–µ—Ä–ø–µ–Ω—å', '–í–µ—Ä–µ—Å–µ–Ω—å', '–ñ–æ–≤—Ç–µ–Ω—å', '–õ–∏—Å—Ç–æ–ø–∞–¥', '–ì—Ä—É–¥–µ–Ω—å'],
                        firstDay: 1
                    },
                    opens: 'center',
                    alwaysShowCalendars: true,
                    autoUpdateInput: false,
                    startDate: moment().startOf('year'),
                    endDate: moment(),
                    ranges: {
                        '–í—ñ–¥–∫—Ä–∏—Ç—ñ': [moment().startOf('year'), moment()],
                        '–ó–∞–∫—Ä–∏—Ç—ñ': [moment('02.01.2025', 'DD.MM.YYYY'), moment()],
                        '–í—ñ–¥ –ø–æ—á–∞—Ç–∫—É': [moment('03.01.2025', 'DD.MM.YYYY'), moment()],
                        '–°—å–æ–≥–æ–¥–Ω—ñ': [moment(), moment()],
                        '–û—Å—Ç–∞–Ω–Ω—ñ 7 –¥–Ω—ñ–≤': [moment().subtract(6, 'days'), moment()],
                        '–ü–æ—Ç–æ—á–Ω–∏–π –º—ñ—Å—è—Ü—å': [moment().startOf('month'), moment().endOf('month')],
                        '–ú–∏–Ω—É–ª–∏–π –º—ñ—Å—è—Ü—å': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                    },
                    showCustomRangeLabel: false
                },
                function (start, end, label) {
                    // –¶—è —Ñ—É–Ω–∫—Ü—ñ—è —Å–ø—Ä–∞—Ü—é—î —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –∫–∞–ª–µ–Ω–¥–∞—Ä –≤—ñ–¥–∫—Ä–∏–≤—Å—è (—Ç–æ–±—Ç–æ –ø—Ä–æ–π—à–æ–≤ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É)
                    if (label === '–í—ñ–¥–∫—Ä–∏—Ç—ñ') {
                        $('#dateRangePicker').val('–í—ñ–¥–∫—Ä–∏—Ç—ñ');
                        $('#dateRangePicker').data('daterangepicker').element.removeClass('active-range');
                        currentFilterType = 'open';
                        loadActsTable(null, null, 'open');
                        this.setStartDate(moment().startOf('year'));
                        this.setEndDate(moment());
                    } else if (label === '–ó–∞–∫—Ä–∏—Ç—ñ') {
                        $('#dateRangePicker').val('–ó–∞–∫—Ä–∏—Ç—ñ');
                        $('#dateRangePicker').data('daterangepicker').element.removeClass('active-range');
                        currentFilterType = 'closed';
                        loadActsTable(null, null, 'closed');
                        this.setStartDate(moment('02.01.2025', 'DD.MM.YYYY'));
                        this.setEndDate(moment());
                    } else {
                        const formatted = `${start.format('DD.MM.YYYY')} - ${end.format('DD.MM.YYYY')}`;
                        $('#dateRangePicker').val(formatted);
                        $('#dateRangePicker').data('daterangepicker').element.addClass('active-range');
                        currentFilterType = 'date_range';
                        loadActsTable(start.format("YYYY-MM-DD 00:00:00"), end.format("YYYY-MM-DD 23:59:59"), null);
                    }
                }
            );

            // –ó–Ω–∞—á–µ–Ω–Ω—è –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
            $('#dateRangePicker').val('–í—ñ–¥–∫—Ä–∏—Ç—ñ');
            currentFilterType = 'open';
            const picker = $('#dateRangePicker').data('daterangepicker');
            if (picker) { picker.setStartDate(moment().startOf('year')); picker.setEndDate(moment()); }

            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–æ—à—É–∫—É
            const searchHandler = setupSearchWithTableFilter(
                loadActsTable,
                () => currentFilterType,
                () => {
                    // –¢—É—Ç —Ç—Ä–µ–±–∞ –æ—Ç—Ä–∏–º–∞—Ç–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ñ –¥–∞—Ç–∏, —è–∫—â–æ –≤–∏–±—Ä–∞–Ω–æ –¥—ñ–∞–ø–∞–∑–æ–Ω
                    // –î–ª—è —Å–ø—Ä–æ—â–µ–Ω–Ω—è –ø–æ–∫–∏ –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ null, —Ü–µ –¥–æ–æ–ø—Ä–∞—Ü—é—î—Ç—å—Å—è –≤ loadActsTable
                    return { dateFrom: null, dateTo: null };
                }
            );
            window.searchHandler = searchHandler;

            initializeActsSystem();

            // –í–ê–ñ–õ–ò–í–û: –ú–µ–Ω—é –ø–æ–∫–∞–∑—É—î–º–æ, –∞–ª–µ –µ–ª–µ–º–µ–Ω—Ç–∏ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∑–∞—Ö–∏—â–µ–Ω—ñ
            updateMenuVisibility(true);
        }

        window.initializeSystem = initializeSystem;

        async function startAuthenticationAndInit() {
            const accessLevel = await showLoginModalBeforeTable();

            if (accessLevel) {
                await updateUIBasedOnAccess(accessLevel);
                updateUserInfoDisplay();
                initializeSystem();
            } else {
                console.error("‚ùå –í—Ö—ñ–¥ –Ω–µ –≤–¥–∞–ª–æ—Å—è –∑–¥—ñ–π—Å–Ω–∏—Ç–∏.");
                // –ù–∞–≤—ñ—Ç—å —è–∫—â–æ –≤—Ö—ñ–¥ –Ω–µ –≤–¥–∞–≤—Å—è, –º–∏ –º–æ–∂–µ–º–æ –ø–æ–∫–∞–∑–∞—Ç–∏ –º–µ–Ω—é (–∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–µ), 
                // –ê–ë–û –∑–∞–ª–∏—à–∏—Ç–∏ —Å—Ö–æ–≤–∞–Ω–∏–º. 
                // –Ø–∫—â–æ —Ö–æ—á–µ—à, —â–æ–± –±—É–ª–æ –≤–∏–¥–Ω–æ "–ó–∞–∫—Ä–∏—Ç—ñ" –∫–Ω–æ–ø–∫–∏ - —Ä–æ–∑–∫–æ–º–µ–Ω—Ç—É–π —Ä—è–¥–æ–∫ –Ω–∏–∂—á–µ:
                // updateMenuVisibility(true); 
                // setupBlockers(); // –Ü –æ–±–æ–≤'—è–∑–∫–æ–≤–æ –Ω–∞–≤—ñ—Å–∏—Ç–∏ –±–ª–æ–∫—É–≤–∞–ª—å–Ω–∏–∫–∏
            }
        }

        startAuthenticationAndInit(); 
    </script>
</body>

</html>